<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' file: blob:;">
  <title>ShaderShow</title>
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/toolbar.css">
  <link rel="stylesheet" href="css/params.css">
  <link rel="stylesheet" href="css/grid.css">
  <link rel="stylesheet" href="css/dialogs.css">
  <link rel="stylesheet" href="css/claude-ai.css">
  <link rel="stylesheet" href="css/benchmark.css">
  <link rel="stylesheet" href="css/mixer.css">
</head>
<body>
  <div id="app">
    <!-- Toolbar -->
    <div id="toolbar">
      <div class="toolbar-group">
        <button id="btn-new" title="New File (Ctrl+N)">
          <span class="icon">&#128462;</span>
        </button>
        <button id="btn-open" title="Open File (Ctrl+O)">
          <span class="icon">&#128194;</span>
        </button>
        <div class="toolbar-separator"></div>
        <button id="btn-play" title="Play/Pause (Space)">
          <span class="icon">&#9658;</span>
        </button>
        <button id="btn-reset" title="Reset Time (Ctrl+R)">
          <span class="icon">&#8634;</span>
        </button>
        <button id="btn-preview" title="Toggle Preview" class="active">
          <span class="icon">&#128065;</span>
        </button>
        <button id="btn-grid" title="Toggle Shader Grid">
          <span class="icon">&#9638;</span>
        </button>
        <button id="btn-editor" title="Toggle Editor" class="active">
          <span class="icon">&lt;/&gt;</span>
        </button>
        <button id="btn-save-shader" title="Save Shader to Active Slot (Ctrl+S)" disabled>
          <span class="icon">&#128190;</span>
        </button>
        <button id="btn-params" title="Toggle Parameters" class="active">
          <span class="icon">P</span>
        </button>
        <div class="toolbar-separator"></div>
        <button id="btn-ndi" title="Toggle NDI Output">
          <span class="icon">NDI</span>
        </button>
        <button id="btn-record" title="Start Recording (Cmd+Shift+R)">
          <span class="icon">REC</span>
        </button>
        <select id="fullscreen-select" title="Fullscreen Display">
          <option value="">⛶ No Fullscreen</option>
        </select>
        <button id="btn-tiled" title="Toggle Tiled Preview">
          <span class="icon">&#9638;</span>
        </button>
        <button id="btn-tile-presets" title="Toggle State Presets">
          <span class="icon">S</span>
        </button>
        <button id="btn-blackout" title="Blackout Fullscreen (B)">
          <span class="icon">&#9679;</span>
        </button>
        <div class="toolbar-separator"></div>
        <button id="btn-ai" title="Claude AI Assistant (Ctrl+Shift+A)">
          <span class="icon">AI</span>
        </button>
        <button id="btn-benchmark" title="Run Benchmark">
          <span class="icon">&#9201;</span>
        </button>
        <button id="btn-settings" title="Settings">
          <span class="icon">&#9881;</span>
        </button>
      </div>

      <div class="toolbar-group">
        <label for="resolution-select">Resolution:</label>
        <select id="resolution-select">
          <option value="640x360">360p (640x360)</option>
          <option value="854x480">480p (854x480)</option>
          <option value="1280x720" selected>720p (1280x720)</option>
          <option value="1536x864">1536x864</option>
          <option value="1920x1080">1080p (1920x1080)</option>
          <option value="2560x1440">1440p (2560x1440)</option>
          <option value="3072x1824">3072x1824</option>
          <option value="3840x2160">4K (3840x2160)</option>
          <option value="custom">Custom</option>
        </select>
        <input type="number" id="custom-width" placeholder="W" min="1" max="4096" value="1280" class="hidden">
        <span id="custom-x" class="hidden">x</span>
        <input type="number" id="custom-height" placeholder="H" min="1" max="4096" value="720" class="hidden">
      </div>

      <div class="toolbar-group fps-display">
        <span id="fullscreen-fps" title="Fullscreen FPS">-- fps</span>
      </div>

      <div class="toolbar-group channels">
        <span class="channel-label">Channels:</span>
        <div class="channel-slot" id="channel-0" title="iChannel0 - Click File > Load Texture">0</div>
        <div class="channel-slot" id="channel-1" title="iChannel1 - Click File > Load Texture">1</div>
        <div class="channel-slot" id="channel-2" title="iChannel2 - Click File > Load Texture">2</div>
        <div class="channel-slot" id="channel-3" title="iChannel3 - Click File > Load Texture">3</div>
      </div>

      <div class="toolbar-group stats">
        <span id="fps-display">FPS: --</span>
        <span id="time-display">Time: 0.00s</span>
        <span id="frame-display">Frame: 0</span>
      </div>
    </div>

    <!-- State Presets Panel (toggleable) -->
    <div id="state-presets-panel" class="hidden">
      <div class="state-presets-header">
        <span>State Presets</span>
        <span class="state-presets-hint">Shift+Click=Save, Click=Recall, Right-Click=Clear</span>
      </div>
      <div id="state-presets-bar" class="state-presets-bar">
        <button class="state-preset-btn" data-preset="0">1</button>
        <button class="state-preset-btn" data-preset="1">2</button>
        <button class="state-preset-btn" data-preset="2">3</button>
        <button class="state-preset-btn" data-preset="3">4</button>
        <button class="state-preset-btn" data-preset="4">5</button>
        <button class="state-preset-btn" data-preset="5">6</button>
        <button class="state-preset-btn" data-preset="6">7</button>
        <button class="state-preset-btn" data-preset="7">8</button>
      </div>
    </div>

    <!-- Main Content -->
    <div id="main-content">
      <!-- Editor Panel -->
      <div id="editor-panel">
        <div id="editor-tabs">
          <!-- Tabs will be added dynamically -->
        </div>
        <div id="editor"></div>
      </div>

      <!-- Resizer -->
      <div id="resizer"></div>

      <!-- Right Panel Container -->
      <div id="right-panel">
        <!-- Preview Panel (on top) -->
        <div id="preview-panel">
          <div id="preview-canvas-container">
            <canvas id="shader-canvas"></canvas>
          </div>
        </div>

        <!-- Shader Presets (between preview and bottom row, always visible) -->
        <div class="grid-presets-section">
          <div class="presets-row" id="local-presets-row">
            <span class="no-shader-hint" id="no-shader-hint">Select a shader</span>
            <button id="btn-add-local-preset" class="preset-btn add-preset hidden" title="Save preset for current shader">+</button>
          </div>
        </div>

        <!-- Shader Mixer Panel -->
        <div id="mixer-panel">
          <div class="mixer-channel" data-channel="0">
            <button class="mixer-btn" title="Click to arm, then click a grid shader to assign. Right-click to clear.">—</button>
            <input type="range" class="mixer-slider" min="0" max="1" step="0.01" value="1">
          </div>
          <div class="mixer-channel" data-channel="1">
            <button class="mixer-btn" title="Click to arm, then click a grid shader to assign. Right-click to clear.">—</button>
            <input type="range" class="mixer-slider" min="0" max="1" step="0.01" value="1">
          </div>
          <div class="mixer-channel" data-channel="2">
            <button class="mixer-btn" title="Click to arm, then click a grid shader to assign. Right-click to clear.">—</button>
            <input type="range" class="mixer-slider" min="0" max="1" step="0.01" value="1">
          </div>
          <div class="mixer-channel" data-channel="3">
            <button class="mixer-btn" title="Click to arm, then click a grid shader to assign. Right-click to clear.">—</button>
            <input type="range" class="mixer-slider" min="0" max="1" step="0.01" value="1">
          </div>
          <select id="mixer-blend-mode" title="Blend mode for compositing">
            <option value="lighter" selected>Add</option>
            <option value="screen">Screen</option>
            <option value="source-over">Normal</option>
            <option value="multiply">Multiply</option>
            <option value="overlay">Overlay</option>
            <option value="hard-light">Hard Light</option>
            <option value="soft-light">Soft Light</option>
            <option value="difference">Difference</option>
            <option value="exclusion">Exclusion</option>
            <option value="color-dodge">Color Dodge</option>
            <option value="color-burn">Color Burn</option>
          </select>
        </div>

        <!-- Vertical Resizer between preview and bottom row -->
        <div id="resizer-vertical"></div>

        <!-- Bottom Row: Grid and Params side by side -->
        <div id="bottom-row">
          <!-- Shader Grid Panel -->
          <div id="grid-panel" class="hidden">
            <div class="shader-grid" id="shader-grid-container">
              <!-- Grid slots are created dynamically by shader-grid.js -->
            </div>
          </div>

          <!-- Horizontal Resizer between grid and params -->
          <div id="resizer-bottom"></div>

          <!-- Parameters Side Panel -->
          <div id="params-panel">
            <!-- Speed control (always visible) -->
            <div class="params-section">
              <div class="params-section-title">Playback</div>
              <div class="param-row">
                <label>Speed</label>
                <input type="range" id="param-speed" min="0" max="5" step="0.01" value="1">
                <span class="param-value" id="param-speed-value">1.00</span>
              </div>
            </div>

            <!-- Dynamic shader parameters container (generated by JS) -->
            <div id="custom-params-container"></div>


            <div class="params-section">
              <button id="btn-reset-params" class="btn-secondary" title="Reset parameters to shader defaults">Reset to Default</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar">
      <span id="status-message">Ready</span>
      <span id="cursor-position">Ln 1, Col 1</span>
    </div>

    <!-- Tile Configuration Dialog -->
    <div id="tile-config-dialog" class="modal hidden">
      <div class="modal-content tile-config-content">
        <div class="modal-header">
          <h2>Configure Tiled Display</h2>
          <button class="modal-close" id="tile-config-close">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Layout Selection -->
          <div class="tile-config-section">
            <label class="tile-config-label">Layout Preset:</label>
            <select id="tile-layout-preset">
              <option value="1x1">1x1 (Single)</option>
              <option value="2x1">2x1 (Dual)</option>
              <option value="1x2">1x2 (Stack)</option>
              <option value="2x2" selected>2x2 (Quad)</option>
              <option value="3x2">3x2</option>
              <option value="2x3">2x3</option>
              <option value="3x3">3x3 (Nine)</option>
              <option value="4x4">4x4 (Sixteen)</option>
              <option value="custom">Custom...</option>
            </select>
            <div id="custom-layout-inputs" class="hidden">
              <input type="number" id="tile-rows" min="1" max="8" value="2" placeholder="Rows">
              <span>x</span>
              <input type="number" id="tile-cols" min="1" max="8" value="2" placeholder="Cols">
            </div>
          </div>

          <div class="tile-config-section">
            <label class="tile-config-label">Gap Size:</label>
            <input type="range" id="tile-gap-size" min="0" max="20" value="4">
            <span id="tile-gap-value">4px</span>
          </div>

          <!-- Tile Presets (save/recall full tiled display state) -->
          <div class="tile-presets-section">
            <div class="tile-presets-label">State Presets (Shift+Click to save, Click to recall):</div>
            <div id="tile-presets-bar" class="tile-presets-bar">
              <button class="tile-preset-btn" data-preset="0">1</button>
              <button class="tile-preset-btn" data-preset="1">2</button>
              <button class="tile-preset-btn" data-preset="2">3</button>
              <button class="tile-preset-btn" data-preset="3">4</button>
              <button class="tile-preset-btn" data-preset="4">5</button>
              <button class="tile-preset-btn" data-preset="5">6</button>
              <button class="tile-preset-btn" data-preset="6">7</button>
              <button class="tile-preset-btn" data-preset="7">8</button>
            </div>
          </div>

          <!-- Tile Preview Grid -->
          <div class="tile-preview-container">
            <div class="tile-preview-label">Tile Assignment (drag shaders from grid below, or click to select):</div>
            <div id="tile-preview-grid" class="tile-preview-grid">
              <!-- Tiles will be generated dynamically -->
            </div>
          </div>

          <!-- Shader Selection (mini grid of available shaders) -->
          <div class="tile-shader-selector">
            <div class="tile-shader-selector-label">Available Shaders (drag to tiles above):</div>
            <div id="tile-shader-list" class="tile-shader-list">
              <!-- Shader thumbnails will be populated from grid slots -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="tile-config-cancel" class="btn btn-secondary">Cancel</button>
          <button id="tile-config-apply" class="btn btn-primary">Apply</button>
          <button id="tile-config-fullscreen" class="btn btn-accent">Open Fullscreen</button>
        </div>
      </div>
    </div>

    <!-- New File Dialog -->
    <div id="new-file-dialog" class="modal hidden">
      <div class="modal-content modal-small">
        <div class="modal-header">
          <h3>New File</h3>
          <button class="modal-close" id="new-file-close">&times;</button>
        </div>
        <div class="modal-body">
          <p class="dialog-prompt">Choose file type:</p>
          <div class="file-type-buttons">
            <button id="new-shader-btn" class="file-type-btn">
              <span class="file-type-icon">&#128196;</span>
              <span class="file-type-label">GLSL Shader</span>
              <span class="file-type-desc">Fragment shader with Shadertoy compatibility</span>
            </button>
            <button id="new-scene-btn" class="file-type-btn">
              <span class="file-type-icon">&#127922;</span>
              <span class="file-type-label">Three.js Scene</span>
              <span class="file-type-desc">3D scene with JavaScript/JSX</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ace Editor -->
  <script src="node_modules/ace-builds/src-min-noconflict/ace.js"></script>
  <script src="node_modules/ace-builds/src-min-noconflict/mode-glsl.js"></script>
  <script src="node_modules/ace-builds/src-min-noconflict/mode-javascript.js"></script>
  <script src="node_modules/ace-builds/src-min-noconflict/mode-jsx.js"></script>
  <script src="node_modules/ace-builds/src-min-noconflict/theme-monokai.js"></script>

  <!-- Three.js and Babel are lazy-loaded on first scene use (saves ~4MB initial load) -->
  <script>
    window.THREE = null;
    window.loadThreeJS = function() {
      if (window.THREE || window._threeLoading) return window._threePromise || Promise.resolve();
      window._threeLoading = true;
      window._threePromise = import('./node_modules/three/build/three.module.js').then(mod => {
        window.THREE = mod;
        window.dispatchEvent(new Event('three-loaded'));
      });
      return window._threePromise;
    };
    window.loadBabel = function() {
      if (window.Babel || window._babelLoading) return window._babelPromise || Promise.resolve();
      window._babelLoading = true;
      window._babelPromise = new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'node_modules/@babel/standalone/babel.min.js';
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
      return window._babelPromise;
    };
  </script>

  <!-- Renderers -->
  <script src="shader-renderer.js"></script>
  <script src="three-scene-renderer.js"></script>
  <script type="module" src="js/renderer.js"></script>
</body>
</html>
